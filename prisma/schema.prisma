// Dosya: prisma/schema.prisma
// --------------------------
// (TÜM MODELLERİ İÇEREN SON HAL)
// --------------------------

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
}

// --- AUTH MODELLERİ (Bunlar Değişmedi) ---
model EmailVerificationToken {
  verificationTokenId Int      @id @default(autoincrement())
  tokenHash           String   @db.NVarChar(256)
  expiresAt           DateTime
  isUsed              Boolean  @default(false)
  lastSentAt          DateTime @default(now())
  sendCount           Int      @default(1)
  requestIP           String   @db.NVarChar(45)
  userAgent           String   @db.NVarChar(512)
  failedAttempts      Int      @default(0)
  userId              String   @db.UniqueIdentifier
  User                User     @relation(fields: [userId], references: [userId], onDelete: Cascade)
}

model PasswordResetToken {
  resetTokenId Int      @id @default(autoincrement())
  tokenHash    String   @db.NVarChar(256)
  expiresAt    DateTime
  isUsed       Boolean  @default(false)
  lastSentAt   DateTime @default(now())
  sendCount    Int      @default(1)
  requestIP    String   @db.NVarChar(45)
  userAgent    String   @db.NVarChar(512)
  failedAttempts Int     @default(0)
  userId       String   @db.UniqueIdentifier
  User         User     @relation(fields: [userId], references: [userId], onDelete: Cascade)
}

model UserExternalLogin {
  id            Int    @id @default(autoincrement())
  loginProvider String @db.NVarChar(50)
  providerKey   String @db.NVarChar(255)
  userId        String @db.UniqueIdentifier
  User          User   @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@unique([loginProvider, providerKey])
}

model UserLocalCredential {
  userId       String @id @db.UniqueIdentifier
  passwordHash String @db.NVarChar(Max)
  User         User   @relation(fields: [userId], references: [userId], onDelete: Cascade)
}

model RefreshToken {
  refreshTokenId Int      @id @default(autoincrement())
  tokenHash      String   @unique @db.NVarChar(256)
  deviceId       String   @db.NVarChar(255)
  expiresAt      DateTime
  isUsed         Boolean  @default(false)
  createdAt      DateTime @default(now())
  createdByIP    String   @db.NVarChar(45)
  userAgent      String   @db.NVarChar(512)
  userId         String   @db.UniqueIdentifier
  User           User     @relation(fields: [userId], references: [userId], onDelete: Cascade)

  // Bir kullanıcının bir cihazda sadece 1 token'ı olabilir
  @@unique([userId, deviceId])
}


// --- ANA KULLANICI MODELİ (Güncellendi) ---
model User {
  userId          String   @id @default(uuid()) @db.UniqueIdentifier
  username        String   @unique @db.NVarChar(100)
  email           String   @unique @db.NVarChar(255)
  isEmailVerified Boolean  @default(false)
  createdAt       DateTime @default(now())

  // Auth İlişkileri
  EmailVerificationToken EmailVerificationToken[]
  PasswordResetToken     PasswordResetToken[]
  RefreshToken           RefreshToken[]
  UserExternalLogin      UserExternalLogin[]
  UserLocalCredential    UserLocalCredential?

  // YENİ PROFİL İLİŞKİLERİ (1:1)
  Profile UserProfile?
  Body    UserBody?
  Goal    UserGoal?
  Setting UserSetting?
  
  // YENİ PROFİL İLİŞKİLERİ (M:N via Junction Tables)
  HealthLimitations  UserHealthLimitation[]
  TargetBodyParts    UserGoalPart[]
  AvailableEquipment UserAvailableWorkoutEquipment[]
  WorkoutLocations   UserWorkoutLocation[]
}


// ---------------------------------------------
// YENİ PROFİL TABLOLARI (1:1)
// ---------------------------------------------

model UserProfile {
  userId    String   @id @db.UniqueIdentifier
  firstName String   @db.NVarChar(100)
  lastName  String   @db.NVarChar(100)
  birthDate DateTime @db.Date
  gender    String   @db.NVarChar(50)

  User User @relation(fields: [userId], references: [userId], onDelete: Cascade)
}

model UserBody {
  userId        String  @id @db.UniqueIdentifier
  heightCM      Decimal @db.Decimal(5, 2)
  weightKG      Decimal @db.Decimal(5, 2)
  activityLevel String  @db.NVarChar(100)
  bodyType      String  @db.NVarChar(100)

  User User @relation(fields: [userId], references: [userId], onDelete: Cascade)
}

model UserGoal {
  userId         String   @id @db.UniqueIdentifier
  primaryGoal    String   @db.NVarChar(100)
  targetWeightKG Decimal? @db.Decimal(5, 2)

  User User @relation(fields: [userId], references: [userId], onDelete: Cascade)
}

model UserSetting {
  userId            String @id @db.UniqueIdentifier
  preferredUnit     String @db.NVarChar(10)
  preferredLanguage String @db.NVarChar(10) @default("tr")
  theme             String @db.NVarChar(10) @default("system")

  User User @relation(fields: [userId], references: [userId], onDelete: Cascade)
}


// ---------------------------------------------
// YENİ ANA VERİ TABLOLARI (GÜNCELLENDİ)
// (Artık "name" sütunları yok)
// ---------------------------------------------

model HealthLimitation {
  healthLimitationId Int    @id @default(autoincrement())

  // İlişki (Kullanıcı)
  users UserHealthLimitation[]

  // İlişki (Çeviri) - YENİ
  translations HealthLimitationTranslation[]
}

model GoalBodyPart {
  goalBodyPartId Int    @id @default(autoincrement())

  // İlişki (Kullanıcı)
  users UserGoalPart[]

  // İlişki (Çeviri) - YENİ
  translations GoalBodyPartTranslation[]
}

model WorkoutEquipment {
  workoutEquipmentId Int    @id @default(autoincrement())

  // İlişki (Kullanıcı)
  users UserAvailableWorkoutEquipment[]

  // İlişki (Çeviri) - YENİ
  translations WorkoutEquipmentTranslation[]
}

model WorkoutLocation {
  workoutLocationId Int    @id @default(autoincrement())

  // İlişki (Kullanıcı)
  users UserWorkoutLocation[]

  // İlişki (Çeviri) - YENİ
  translations WorkoutLocationTranslation[]
}

// ---------------------------------------------
// YENİ ÇEVİRİ TABLOLARI
// (Sizin tasarımınıza göre)
// ---------------------------------------------

model HealthLimitationTranslation {
  healthLimitationId Int
  languageCode       String @db.NVarChar(10) // tr, en, de
  name               String @db.NVarChar(100)
  description        String? @db.NVarChar(Max)

  // İlişki
  HealthLimitation HealthLimitation @relation(fields: [healthLimitationId], references: [healthLimitationId], onDelete: Cascade)

  // Bileşik Anahtar
  @@id([healthLimitationId, languageCode])
}

model GoalBodyPartTranslation {
  goalBodyPartId Int
  languageCode   String @db.NVarChar(10)
  name           String @db.NVarChar(100)
  description    String? @db.NVarChar(Max)

  // İlişki
  GoalBodyPart GoalBodyPart @relation(fields: [goalBodyPartId], references: [goalBodyPartId], onDelete: Cascade)

  // Bileşik Anahtar
  @@id([goalBodyPartId, languageCode])
}

model WorkoutEquipmentTranslation {
  workoutEquipmentId Int
  languageCode       String @db.NVarChar(10)
  name               String @db.NVarChar(100)
  description        String? @db.NVarChar(Max)

  // İlişki
  WorkoutEquipment WorkoutEquipment @relation(fields: [workoutEquipmentId], references: [workoutEquipmentId], onDelete: Cascade)

  // Bileşik Anahtar
  @@id([workoutEquipmentId, languageCode])
}

model WorkoutLocationTranslation {
  workoutLocationId Int
  languageCode      String @db.NVarChar(10)
  name              String @db.NVarChar(100)
  description       String? @db.NVarChar(Max)

  // İlişki
  WorkoutLocation WorkoutLocation @relation(fields: [workoutLocationId], references: [workoutLocationId], onDelete: Cascade)

  // Bileşik Anahtar
  @@id([workoutLocationId, languageCode])
}


// ---------------------------------------------
// YENİ İLİŞKİ TABLOLARI (M:N Junction Tables)
// (Bunlar Değişmedi)
// ---------------------------------------------

model UserHealthLimitation {
  userId             String @db.UniqueIdentifier
  healthLimitationId Int

  // İlişkiler
  User             User             @relation(fields: [userId], references: [userId], onDelete: Cascade)
  HealthLimitation HealthLimitation @relation(fields: [healthLimitationId], references: [healthLimitationId], onDelete: Cascade)

  // Bileşik Anahtar
  @@id([userId, healthLimitationId])
}

model UserGoalPart {
  userId         String @db.UniqueIdentifier
  goalBodyPartId Int

  // İlişkiler
  User         User         @relation(fields: [userId], references: [userId], onDelete: Cascade)
  GoalBodyPart GoalBodyPart @relation(fields: [goalBodyPartId], references: [goalBodyPartId], onDelete: Cascade)

  // Bileşik Anahtar
  @@id([userId, goalBodyPartId])
}

model UserAvailableWorkoutEquipment {
  userId             String @db.UniqueIdentifier
  workoutEquipmentId Int

  // İlişkiler
  User             User             @relation(fields: [userId], references: [userId], onDelete: Cascade)
  WorkoutEquipment WorkoutEquipment @relation(fields: [workoutEquipmentId], references: [workoutEquipmentId], onDelete: Cascade)

  // Bileşik Anahtar
  @@id([userId, workoutEquipmentId])
}

model UserWorkoutLocation {
  userId            String @db.UniqueIdentifier
  workoutLocationId Int

  // İlişkiler
  User            User            @relation(fields: [userId], references: [userId], onDelete: Cascade)
  WorkoutLocation WorkoutLocation @relation(fields: [workoutLocationId], references: [workoutLocationId], onDelete: Cascade)

  // Bileşik Anahtar
  @@id([userId, workoutLocationId])
}